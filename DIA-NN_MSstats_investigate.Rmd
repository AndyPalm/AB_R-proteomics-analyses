```{r}
# --- 1. Setup & Paths ---
# Adjust these paths to match your current experiment folder structure
box_root  <- "C:/Users/andbp/Box/Backus_Lab/Andrew_Becker/ABecker_Lab_Notebook/R_WD"
# Assuming standard FragPipe output structure, but adjust 'exp_dir' as needed
exp_dir   <- file.path(box_root, "") 
parquet_dir <- file.path(exp_dir, "02_R_Intermediates") # Or wherever you prefer to store cache

if (!dir.exists(parquet_dir)) {dir.create(parquet_dir, recursive = TRUE)}

library(tidyverse)
library(pbapply)
library(ggrepel)
library(RColorBrewer)
library(readxl)
library(janitor)
library(here)
library(arrow)
library(Hmisc)
library(beeswarm)

# --- 2. Convert report.tsv to Parquet ---

# Define source (DIA-NN report) and target (Parquet)
# Note: Ensure this points to the main 'report.tsv', not the matrices.
tsv_source <- file.path(exp_dir, "report.tsv")
pq_target  <- file.path(parquet_dir, "report.parquet")

if (!file.exists(pq_target)) {
  message("Parquet file not found. Reading report.tsv and converting... (This allows faster future loads)")
  
  # specific function for tab-separated files in arrow
  temp_df <- arrow::read_tsv_arrow(tsv_source) 
  
  arrow::write_parquet(temp_df, pq_target)
  
  rm(temp_df)
  gc()
  message("Conversion complete.")
} else {
  message("Parquet file found. Loading cached data.")
}

# --- 3. Load & Investigate ---

# Load the optimized file
report_data <- arrow::read_parquet(pq_target)

# Filter for the "Mystery Protein" (ESYT2 / A0FGR8)
# We look in both Protein.Ids and Genes to be safe
target_protein <- report_data %>%
  filter(
    str_detect(`Protein.Ids`, "A0FGR8") | 
    str_detect(`Genes`, "ESYT2")
  )

# --- 4. Diagnostic Report for MSstats Dropout ---

message("--- INVESTIGATION REPORT FOR ESYT2 ---")

# A. Check Uniqueness (The #1 reason MSstats drops proteins)
# MSstats default: use_only_unique_peptides = TRUE
unique_peptides <- target_protein %>%
  distinct(Stripped.Sequence) %>%
  pull(Stripped.Sequence)

n_unique <- length(unique_peptides)
message(paste("Number of unique peptide sequences found:", n_unique))

if (n_unique == 1) {
  message("WARNING: Only 1 peptide found. MSstats default 'removeProtein_with1Peptide = TRUE' likely dropped this.")
}

# B. Check Proteotypicity (Shared Peptides)
# If 'Proteotypic' column exists (standard in DIA-NN), 0 means shared.
if ("Proteotypic" %in% names(target_protein)) {
  is_proteotypic <- target_protein %>%
    distinct(Stripped.Sequence, Proteotypic)
  
  print("Peptide Proteotypicity (1=Unique, 0=Shared):")
  print(is_proteotypic)
  
  if (all(is_proteotypic$Proteotypic == 0)) {
    message("WARNING: All peptides are marked as non-proteotypic (shared). MSstats drops these by default.")
  }
}

# C. Check Missingness / Intensity
# Check how many runs actually have a quantified value (Precursor.Quantity)
runs_with_data <- target_protein %>%
  filter(!is.na(Precursor.Quantity) & Precursor.Quantity > 0) %>%
  distinct(Run) %>%
  nrow()

total_runs <- n_distinct(report_data$Run)

message(paste0("Protein quantified in ", runs_with_data, " out of ", total_runs, " runs."))

if (runs_with_data < (total_runs / 2)) {
  message("WARNING: High missingness. MSstats 'fewMeasurements' filter might have dropped this.")
}

# View the raw features for this protein to inspect manually
print(head(target_protein))
```